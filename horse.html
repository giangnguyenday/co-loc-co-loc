<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#ffffff" />
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/favicon/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="./assets/favicon/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="./assets/favicon/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="./assets/favicon/android-chrome-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="./assets/favicon/android-chrome-512x512.png" />
    <link rel="icon" href="./assets/favicon/favicon.ico" />
    <script>
      (function () {
        function applyThemeColor() {
          const params = new URLSearchParams(window.location.search);
          const id = params.get("horse") || params.get("id");
          if (!id) {
            window.__missingHorseId = true;
            return;
          }
          const themes = {
            "01": { top: "#a4bddd", bottom: "#a4bddd", bg: "#a4bddd" },
            "02": { top: "#40401a", bottom: "#40401a", bg: "#40401a" },
            "03": {
              top: "#ff5622",
              bottom: "#ff6ffa",
              bg: "linear-gradient(180deg, #ff5622, #ff6ffa)"
            },
            "04": { top: "#d50b0b", bottom: "#d50b0b", bg: "#d50b0b" },
            "05": {
              top: "#40401a",
              bottom: "#ffff90",
              bg: "linear-gradient(180deg, #40401a, #ffff90)"
            },
            "06": { top: "#ff6ffa", bottom: "#ff6ffa", bg: "#ff6ffa" },
            "07": {
              top: "#ff9bd7",
              bottom: "#60e6ff",
              bg: "linear-gradient(180deg, #ff9bd7, #60e6ff)"
            }
          };
          const theme = themes[id] || themes["01"];
          const meta = document.querySelector('meta[name="theme-color"]');
          if (meta) {
            meta.setAttribute("content", theme.top);
          }
          const root = document.documentElement.style;
          root.setProperty("--horse-bg", theme.bg);
          root.setProperty("--horse-bg-solid", theme.top);
          root.setProperty("--horse-bg-top", theme.top);
          root.setProperty("--horse-bg-bottom", theme.bottom);
          window.__horseThemeReady = true;
        }

        applyThemeColor();
        window.addEventListener("pageshow", applyThemeColor);
      })();
    </script>
    <title data-i18n="title.horse">Co Loc Co Loc - Your Fortune</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Google+Sans+Flex:opsz,wdth,wght@6..144,25..151,1..1000&display=swap"
    />
    <link rel="stylesheet" href="./css/styles.css" />
    <link rel="stylesheet" href="./css/preloader.css" />
  </head>
  <body class="page page--horse is-preloading">
    <div class="page-preloader" id="pagePreloader" aria-hidden="true">
      <div class="preloader-track" aria-hidden="true">
        <div class="preloader-footprint" data-footprint="template">
          <svg width="33" height="30" viewBox="0 0 33 30" fill="none" xmlns="http://www.w3.org/2000/svg">
            <g opacity="0.05">
              <path d="M8.51999 29.1C5.92999 29.1 3.85999 28.55 2.31999 27.45C0.779992 26.35 0 24.91 0 23.12C0 21.33 0.779991 19.8 2.34999 18.68C3.91999 17.56 5.99 17 8.56 17C9.18 17 9.79999 17.04 10.43 17.11C11.06 17.18 11.67 17.3 12.26 17.44C12.85 17.58 13.62 17.84 14.58 18.21L13.57 21.15C12.67 20.84 11.99 20.64 11.53 20.54C11.07 20.44 10.56 20.37 10 20.31C9.44 20.25 8.96999 20.22 8.59999 20.22C7.14999 20.22 6.02 20.47 5.19 20.97C4.36 21.47 3.95 22.16 3.95 23.05C3.95 23.94 4.38 24.61 5.25 25.12C6.12 25.63 7.24999 25.88 8.65999 25.88C9.00999 25.88 9.47 25.85 10.03 25.78C10.59 25.71 11.1 25.62 11.56 25.51C12.02 25.4 12.73 25.14 13.68 24.73L15.08 27.52C14.22 27.95 13.45 28.28 12.78 28.49C12.1 28.71 11.39 28.86 10.64 28.96C9.89 29.06 9.17999 29.11 8.50999 29.11L8.51999 29.1Z" fill="#231F20"/>
              <path d="M25.53 12.1C22.94 12.1 20.87 11.55 19.33 10.45C17.79 9.35 17.01 7.91 17.01 6.12C17.01 4.33 17.79 2.8 19.36 1.68C20.93 0.56 23 0 25.57 0C26.19 0 26.81 0.0399997 27.44 0.11C28.07 0.18 28.68 0.3 29.27 0.44C29.86 0.59 30.63 0.84 31.59 1.21L30.58 4.15C29.68 3.84 29 3.64 28.54 3.54C28.08 3.44 27.57 3.37 27.01 3.31C26.45 3.25 25.98 3.22 25.61 3.22C24.16 3.22 23.03 3.47 22.2 3.97C21.37 4.47 20.96 5.16 20.96 6.05C20.96 6.94 21.39 7.61 22.26 8.12C23.13 8.63 24.26 8.88 25.67 8.88C26.02 8.88 26.48 8.85 27.04 8.78C27.6 8.71 28.11 8.62 28.57 8.51C29.03 8.4 29.74 8.14 30.69 7.73L32.09 10.52C31.23 10.95 30.46 11.28 29.79 11.49C29.11 11.71 28.4 11.86 27.65 11.96C26.9 12.06 26.19 12.11 25.52 12.11L25.53 12.1Z" fill="#231F20"/>
            </g>
          </svg>
        </div>
      </div>
      <div class="preloader-center" style="--delay: 0.7s;" aria-hidden="true">
        <svg width="57" height="50" viewBox="0 0 57 50" fill="none" xmlns="http://www.w3.org/2000/svg">
          <g clip-path="url(#clip0_750_2170)">
            <path d="M7.61989 10.22C7.15989 10.22 6.67989 10.43 6.38989 10.74V13.65C6.38989 14.34 6.84989 14.7 7.44989 14.7C8.62989 14.7 9.61989 13.79 9.61989 12.41C9.61989 11.03 8.74989 10.22 7.60989 10.22H7.61989Z" fill="white"/>
            <path d="M55.89 34.78C55.6 29.38 56.03 19.82 49.02 18.99C51.87 15.75 53.95 13.23 54.54 8.41C55.08 3.94 54.24 0 54.24 0H36.56C38.6 2.66 41.48 10.11 39.01 14.24C37.41 16.92 33.6 17.11 32.38 12.38C29.44 0.900001 18.37 0 8.87 0H0L1.22 21.9L5.85 21.96L10.64 19.27C10.64 22.69 7.35 26.28 1.22 26.28L0 49.61H10.49C13.62 49.61 16.16 47.07 16.16 43.94V43.21C18.81 45.72 22.97 47.31 28.35 47.31C33.73 47.31 37.85 45.72 40.52 43.21V43.94C40.52 47.07 43.06 49.61 46.19 49.61H56.69L55.89 34.78ZM6.45 15.89C5.36 15.89 4.58 15.34 4.58 14.14L4.56 7.41C4.56 6.86 4.2 6.51 3.69 6.42C3.55 6.39 3.5 6.33 3.5 6.21V5.91C3.5 5.79 3.55 5.72 3.65 5.67C4.62 5.27 5.06 4.95 5.67 4.4C5.76 4.31 5.84 4.28 5.95 4.28H6.2C6.32 4.29 6.38 4.37 6.38 4.47L6.35 9.45C6.81 8.99 7.47 8.61 8.45 8.61C10.04 8.61 11.19 9.64 11.19 11.46C11.19 14.16 9 15.9 6.44 15.9L6.45 15.89Z" fill="white"/>
          </g>
          <defs>
            <clipPath id="clip0_750_2170">
              <rect width="56.69" height="49.61" fill="white"/>
            </clipPath>
          </defs>
        </svg>
      </div>
    </div>
    <div class="horse-safe-top" aria-hidden="true"></div>
    <div class="horse-safe-bottom" aria-hidden="true"></div>
    <div class="horse-bg" aria-hidden="true"></div>
    <div class="horse-split-right" aria-hidden="true"></div>
    <header class="topbar">
      <a class="brand" href="index.html" aria-label="Ca Loc Ca Loc">
        <svg width="20" height="29" viewBox="0 0 20 29" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M7.43083 12.9135C8.6372 11.7536 10.349 10.8177 12.8802 10.8177C17.0047 10.8177 20 13.3995 20 17.9252C20 24.6604 14.3195 29 7.66571 29C4.82642 29 2.80265 27.6161 2.80265 24.6225L2.76319 7.8205C2.76319 6.43479 1.82365 5.57482 0.508296 5.35079C0.158787 5.27491 0.00282288 5.12676 0.00282288 4.82686V4.07709C-0.0234842 3.81513 0.136238 3.57123 0.391793 3.47909C2.92104 2.46916 4.05036 1.68327 5.65322 0.301169C5.83925 0.0970159 6.11171 -0.0131904 6.39358 0.00126286H7.05501C7.31996 0.00848951 7.53042 0.219869 7.5229 0.476415C7.5229 0.480028 7.5229 0.483642 7.5229 0.487255L7.43083 12.9135ZM7.50975 23.3921C7.50975 25.1121 8.71424 26.01 10.272 26.01C13.3462 26.01 15.9092 23.7282 15.9092 20.2865C15.9092 16.8448 13.6543 14.8249 10.6948 14.8249C9.49594 14.8303 8.3497 15.3019 7.51539 16.1293L7.50975 23.3921Z" fill="#D50B0B"/>
        </svg>
      </a>
      <nav class="nav">
        <a class="nav-link nav-link--info" href="info.html" data-i18n="nav.info">Information</a>
        <a
          id="langToggle"
          class="nav-link nav-link--lang"
          href="#"
          aria-label="Switch language to Vietnamese"
          data-i18n="nav.lang"
          data-i18n-attr="aria-label:nav.langLabel"
        >VIE</a>
      </nav>
    </header>

    <main class="main horse-main">
      <section class="horse-card" id="horseCard">
        <div class="horse-meta">
          <div id="horseCodeTop" class="heading-3">CODE 01</div>
          <div id="horseCodeName" class="highlight">Giải Mã Vận May</div>
        </div>

        <div class="horse-visual">
          <div class="horse-circle horse-viewport" aria-hidden="true">
            <div id="horse3dMount" class="horse-viewport-inner"></div>
          </div>
        </div>

        <div class="horse-panel">
          <div class="horse-content">
            <div
              class="fortune-carousel"
              id="fortuneCarousel"
              role="region"
              aria-label="Fortune details"
              data-i18n-attr="aria-label:aria.fortuneDetails"
            >
              <div class="fortune-track">
                <div class="fortune-slide" data-slide="0">
                  <div id="horseFortune" class="heading-2">A wish for fortune and prosperity.</div>
                </div>
                <div class="fortune-slide" data-slide="1">
                  <div class="fortune-detail">
                    <div id="horseDescription" class="body-text">
                      Tựa hình ảnh chú ngựa thong dong sải bước khắp địa cầu, chúc cho mọi
                      hành trình của bạn luôn suôn sẻ; dù vượt vạn dặm xa xôi, vẫn luôn may
                      mắn và bình an.
                    </div>
                    <div class="horse-meta inline">
                      <div id="horseCodeBottom" class="heading-3">DESIGNER</div>
                      <div id="horseDesigner" class="highlight">Giang Nguyễn</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="fortune-dots" role="tablist" aria-label="Fortune pages">
              <button
                class="fortune-dot is-active"
                type="button"
                aria-label="Fortune message"
                data-i18n-attr="aria-label:aria.fortuneMessage"
                aria-current="true"
                data-slide="0"
              ></button>
              <button
                class="fortune-dot"
                type="button"
                aria-label="Fortune description"
                data-i18n-attr="aria-label:aria.fortuneDescription"
                data-slide="1"
              ></button>
            </div>
          </div>

          <div class="fortune-actions">
            <button
              class="btn fortune-button share-button"
              type="button"
              aria-label="Share"
              data-i18n-attr="aria-label:cta.share"
            >
              <svg width="22" height="28" viewBox="0 0 22 28" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <g clip-path="url(#clip0_103_6)">
                  <path d="M9.62998 4.96V20.18H12.23V4.96L15.18 7.91L17.01 6.08L10.93 0L4.84998 6.08L6.67998 7.91L9.62998 4.96Z" fill="currentColor"/>
                  <path d="M18.95 9.55078H15.18V12.1508H18.95C19.16 12.1508 19.25 12.2508 19.25 12.4508V24.8908C19.25 25.1008 19.15 25.1908 18.95 25.1908H2.91001C2.70001 25.1908 2.61001 25.0908 2.61001 24.8908V12.4508C2.61001 12.2408 2.71001 12.1508 2.91001 12.1508L6.69001 12.1808V9.58078L2.92001 9.55078C1.29001 9.55078 0.0100098 10.8308 0.0100098 12.4608V24.9008C0.0100098 26.5308 1.29001 27.8108 2.92001 27.8108H18.97C20.6 27.8108 21.88 26.5308 21.88 24.9008V12.4608C21.88 10.8308 20.6 9.55078 18.97 9.55078H18.95Z" fill="currentColor"/>
                </g>
                <defs>
                  <clipPath id="clip0_103_6">
                    <rect width="21.86" height="27.81" fill="white"/>
                  </clipPath>
                </defs>
              </svg>
            </button>
            <a class="btn fortune-button heading-3" href="index.html" data-i18n="cta.drawMore">Draw more fortune</a>
          </div>
        </div>
      </section>
    </main>

    <script type="module" src="./js/i18n.js"></script>
    <script type="module" src="./js/horse.js"></script>
    <script type="module" src="./js/share.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/RGBELoader.js" defer></script>
    <script src="js/render.js" defer></script>
    <script>
      window.addEventListener("DOMContentLoaded", () => {
        const HORSE_MAP = {
          "01": "giang",
          "02": "lam",
          "03": "phong",
          "04": "nhan",
          "05": "nha",
          "06": "jinny",
          "07": "banglam"
        };

        const params = new URLSearchParams(window.location.search);
        const horseParam = params.get("horse");
        const normalized = horseParam ? horseParam.trim().toLowerCase() : "";
        const horseKey = /^\d+$/.test(normalized)
          ? normalized.padStart(2, "0")
          : normalized;

        let modelName = HORSE_MAP[horseKey];
        if (!modelName) {
          const knownModels = new Set(Object.values(HORSE_MAP));
          if (knownModels.has(normalized)) {
            modelName = normalized;
          }
        }
        if (!modelName) {
          modelName = "giang";
        }

        if (typeof currentModelName !== "undefined") {
          currentModelName = modelName;
        }

        const mountCanvas = () => {
          const mount = document.getElementById("horse3dMount");
          const canvas = document.getElementById("canvas");
          if (mount && canvas && canvas.parentElement !== mount) {
            mount.appendChild(canvas);
          }
        };

        const loadDesiredModel = () => {
          if (typeof loadModel === "function") {
            loadModel(modelName);
          }
          mountCanvas();
        };

        const applySettingsFromFile = async () => {
          try {
            const response = await fetch("js/settings.json", { cache: "no-store" });
            if (!response.ok) {
              throw new Error(`js/settings.json ${response.status}`);
            }
            const data = await response.json();
            const settings = data.settings ?? data;
            if (typeof applySettings === "function") {
              applySettings(settings);
              loadDesiredModel();
              return;
            }
          } catch (error) {
            console.warn("Failed to load js/settings.json", error);
          }

          loadDesiredModel();
        };

        applySettingsFromFile();
        window.addEventListener("resize", mountCanvas);
        window.addEventListener("pageshow", mountCanvas);
      });
    </script>
  </body>
</html>
